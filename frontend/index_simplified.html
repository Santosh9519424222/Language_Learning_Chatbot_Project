<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ PDF Learning Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
        }
        .header p {
            font-size: 0.95em;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        input[type="text"], input[type="file"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            font-family: inherit;
        }
        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .flex-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-ok { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .loading { text-align: center; color: #667eea; padding: 20px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .chat-messages {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            animation: slideIn 0.3s ease;
        }
        .chat-user { background: #e3f2fd; border-left: 3px solid #0277bd; }
        .chat-ai { background: #f1f8e9; border-left: 3px solid #2e7d32; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ PDF Learning Platform</h1>
            <p>AI-Powered Learning with 7 Specialized Agents</p>
        </div>

        <div class="content">
            <!-- Backend Connection -->
            <div class="section">
                <h3>üîå Backend Connection</h3>
                <div class="flex-row">
                    <input type="text" id="backendUrl" placeholder="http://localhost:8080" style="flex:1;">
                    <button onclick="autoDetectBackend()">üîç Auto-Detect</button>
                </div>
                <div id="backendStatus" style="margin-top:10px; font-size:0.9em; color:#666;">Click Auto-Detect...</div>
            </div>

            <!-- System Status -->
            <div class="section" id="statusSection" style="display:none;">
                <h3>üî• System Status</h3>
                <div id="statusContent"></div>
            </div>

            <!-- Upload PDF -->
            <div class="section">
                <h3>üìÑ Upload PDF</h3>
                <form id="uploadForm" onsubmit="uploadPDF(event)">
                    <div style="margin-bottom:15px;">
                        <button type="button" onclick="document.getElementById('pdfFile').click()" style="width:100%;">
                            üìÅ Choose PDF File
                        </button>
                        <input type="file" id="pdfFile" accept=".pdf" style="display:none;" onchange="updateFileName()">
                        <small id="fileName" style="display:block; margin-top:8px; color:#666;">No file chosen</small>
                    </div>
                    <div style="margin-bottom:15px;">
                        <div class="flex-row">
                            <input type="text" id="userId" placeholder="Your UUID (or generate)" style="flex:1;">
                            <button type="button" onclick="generateUUID()" style="background:#6c757d;">üé≤ Generate</button>
                        </div>
                    </div>
                    <button type="submit" style="width:100%; background:#28a745;">üöÄ Upload & Process</button>
                </form>
                <div id="uploadResult" style="margin-top:15px;"></div>
            </div>

            <!-- Chat Section -->
            <div class="section" id="chatSection" style="display:none;">
                <h3>üí¨ Chat with PDF</h3>
                <div id="currentPDFInfo" style="background:white; padding:10px; border-radius:6px; margin-bottom:15px; border-left:3px solid #0277bd; color:#0277bd;"></div>

                <div class="chat-messages" id="chatMessages"></div>

                <div class="flex-row" style="gap:8px;">
                    <textarea id="chatInput" placeholder="Ask a question..." style="min-height:50px; resize:vertical;"></textarea>
                    <button onclick="sendMessage()" style="align-self:flex-end; background:#667eea;">üì§ Send</button>
                </div>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button type="button" onclick="insertQuestion('What is the main topic?')" style="background:#e3f2fd; color:#0277bd; border:1px solid #0277bd;">üìö Topic?</button>
                    <button type="button" onclick="insertQuestion('Summarize this')" style="background:#e8f5e9; color:#2e7d32; border:1px solid #2e7d32;">üìù Summarize</button>
                    <button type="button" onclick="insertQuestion('Key points?')" style="background:#fff3e0; color:#e65100; border:1px solid #e65100;">üéØ Key Points</button>
                </div>
            </div>

            <!-- Agent Selector -->
            <div class="section" id="agentSection" style="display:none;">
                <h3>ü§ñ More Options</h3>
                <select id="agentSelector" onchange="switchAgent()" style="margin-bottom:15px;">
                    <option value="">Select an option...</option>
                    <option value="feedback">üéì Language Feedback</option>
                    <option value="translate">üåç Translate</option>
                    <option value="report">üìä Learning Report</option>
                </select>
                <div id="agentPanel"></div>
            </div>
        </div>
    </div>

    <script>
        let API_BASE = localStorage.getItem('backend_base') || 'http://localhost:8080';
        let currentPDF = { file_id: null, filename: null };
        let chatActive = false;

        // Auto-detect backend
        async function autoDetectBackend() {
            try {
                const response = await fetch(API_BASE + '/health', { mode: 'cors' });
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('backend_base', API_BASE);
                    updateBackendStatus('‚úÖ Connected: ' + API_BASE, 'ok');
                    showStatus(data);
                    document.getElementById('statusSection').style.display = 'block';
                    document.getElementById('agentSection').style.display = 'block';
                    return;
                }
            } catch (e) {
                console.error(e);
            }
            updateBackendStatus('‚ùå Connection failed', 'error');
        }

        function updateBackendStatus(msg, type) {
            const el = document.getElementById('backendStatus');
            el.textContent = msg;
            el.style.color = type === 'ok' ? '#28a745' : '#dc3545';
        }

        function showStatus(data) {
            const html = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><strong>Status:</strong> <span class="status-badge status-${data.overall_status === 'healthy' ? 'ok' : 'warning'}">${data.overall_status}</span></div>
                    <div><strong>Agents:</strong> ${data.agents_active}/${data.agents_total}</div>
                    <div><strong>Gemini:</strong> <span class="status-badge status-ok">${data.gemini_api}</span></div>
                    <div><strong>Quota:</strong> ${data.gemini_quota?.requests_remaining || 0}/60</div>
                </div>
            `;
            document.getElementById('statusContent').innerHTML = html;
        }

        // Upload PDF
        function updateFileName() {
            const file = document.getElementById('pdfFile').files[0];
            document.getElementById('fileName').textContent = file ? `‚úì ${file.name}` : 'No file chosen';
        }

        function generateUUID() {
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            document.getElementById('userId').value = uuid;
        }

        async function uploadPDF(e) {
            e.preventDefault();
            const file = document.getElementById('pdfFile').files[0];
            const userId = document.getElementById('userId').value;
            if (!file || !userId) {
                alert('Please select a PDF and enter/generate UUID');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', userId);

            try {
                const response = await fetch(API_BASE + '/api/pdfs/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    currentPDF = { file_id: data.file_id, filename: data.filename };
                    document.getElementById('uploadResult').innerHTML = `<div class="success">‚úÖ Uploaded: ${data.filename}</div>`;
                    document.getElementById('chatSection').style.display = 'block';
                    updatePDFDisplay();
                    document.getElementById('chatMessages').innerHTML = '';
                    chatActive = true;
                } else {
                    document.getElementById('uploadResult').innerHTML = `<div class="error">‚ùå Upload failed: ${data.error}</div>`;
                }
            } catch (e) {
                document.getElementById('uploadResult').innerHTML = `<div class="error">‚ùå Error: ${e.message}</div>`;
            }
        }

        function updatePDFDisplay() {
            document.getElementById('currentPDFInfo').innerHTML = `üìÑ ${currentPDF.filename} | Ready for questions`;
        }

        // Chat
        function insertQuestion(q) {
            document.getElementById('chatInput').value = q;
            document.getElementById('chatInput').focus();
        }

        async function sendMessage() {
            const msg = document.getElementById('chatInput').value.trim();
            if (!msg || !currentPDF.file_id) return;

            addChatMessage('user', msg);
            document.getElementById('chatInput').value = '';

            try {
                const response = await fetch(API_BASE + '/api/chat/question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_id: currentPDF.file_id, question: msg, language_level: 'Intermediate' })
                });
                const data = await response.json();
                if (response.ok) {
                    addChatMessage('ai', data.answer + `\n\nüìÑ Page: ${data.source_page} | üéØ Confidence: ${(data.confidence*100).toFixed(0)}%`);
                } else {
                    addChatMessage('ai', '‚ùå Error: ' + (data.error || 'Failed to get answer'));
                }
            } catch (e) {
                addChatMessage('ai', '‚ùå ' + e.message);
            }
        }

        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = `chat-message chat-${role === 'user' ? 'user' : 'ai'}`;
            div.textContent = (role === 'user' ? 'üë§ ' : 'ü§ñ ') + text;
            document.getElementById('chatMessages').appendChild(div);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        // Agent selector
        function switchAgent() {
            const agent = document.getElementById('agentSelector').value;
            const panel = document.getElementById('agentPanel');
            if (agent === 'feedback') {
                panel.innerHTML = `
                    <textarea id="feedbackText" placeholder="Enter text to analyze..." style="margin-bottom:10px;"></textarea>
                    <button onclick="getFeedback()">‚úÖ Get Feedback</button>
                    <div id="feedbackResult" style="margin-top:15px;"></div>
                `;
            } else if (agent === 'translate') {
                panel.innerHTML = `
                    <select id="translateLang" style="margin-bottom:10px;">
                        <option value="es">Spanish</option>
                        <option value="hi">Hindi</option>
                        <option value="fr">French</option>
                    </select>
                    <button onclick="translate()">üåê Translate</button>
                    <div id="translateResult" style="margin-top:15px;"></div>
                `;
            } else if (agent === 'report') {
                panel.innerHTML = `
                    <button onclick="generateReport()">üìä Generate Report</button>
                    <div id="reportResult" style="margin-top:15px;"></div>
                `;
            }
        }

        async function getFeedback() {
            const text = document.getElementById('feedbackText').value;
            if (!text) return;
            try {
                const response = await fetch(API_BASE + '/api/language-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_output: text, language: 'en' })
                });
                const data = await response.json();
                document.getElementById('feedbackResult').innerHTML = `
                    <div style="background:#fff3cd; padding:15px; border-radius:6px;">
                        <strong>‚úèÔ∏è Grammar:</strong> ${data.grammar_feedback}<br>
                        <strong>üí™ Keep it up!</strong> ${data.encouragement}
                    </div>
                `;
            } catch (e) {
                document.getElementById('feedbackResult').innerHTML = `<div class="error">‚ùå ${e.message}</div>`;
            }
        }

        async function translate() {
            if (!currentPDF.file_id) { alert('Upload PDF first'); return; }
            const lang = document.getElementById('translateLang').value;
            try {
                const response = await fetch(API_BASE + '/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_id: currentPDF.file_id, target_language: lang })
                });
                const data = await response.json();
                document.getElementById('translateResult').innerHTML = `
                    <div class="success">‚úÖ Translation complete to ${lang}</div>
                `;
            } catch (e) {
                document.getElementById('translateResult').innerHTML = `<div class="error">‚ùå ${e.message}</div>`;
            }
        }

        async function generateReport() {
            if (!currentPDF.file_id) { alert('Upload PDF first'); return; }
            try {
                const response = await fetch(API_BASE + `/api/reports/${currentPDF.file_id}`);
                const data = await response.json();
                document.getElementById('reportResult').innerHTML = `
                    <div class="success">
                        <strong>üìä Learning Report</strong><br>
                        Accuracy: ${data.accuracy}%<br>
                        ${data.recommendations?.length > 0 ? '<strong>Recommendations:</strong><br>' + data.recommendations.join('<br>') : ''}
                    </div>
                `;
            } catch (e) {
                document.getElementById('reportResult').innerHTML = `<div class="error">‚ùå ${e.message}</div>`;
            }
        }

        // Auto-detect on load
        window.addEventListener('load', autoDetectBackend);
    </script>
</body>
</html>

