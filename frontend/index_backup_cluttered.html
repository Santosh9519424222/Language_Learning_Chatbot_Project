<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent PDF Learning Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .status-card h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status-item h4 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .status-item p {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .badge.healthy {
            background: #d4edda;
            color: #155724;
        }
        .badge.degraded {
            background: #fff3cd;
            color: #856404;
        }
        .badge.unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        .endpoints {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .endpoints h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .endpoint-list {
            list-style: none;
        }
        .endpoint-list li {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .endpoint-list li span {
            font-weight: bold;
            color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Multi-Agent PDF Learning Platform</h1>
            <p>AI-Powered Language Learning with 7 Specialized Agents</p>
        </div>

        <div class="content">
            <div class="status-card" style="margin-top:15px;">
                <h3>üîå Backend Connection</h3>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <input id="backendUrlInput" type="text" placeholder="Backend base (e.g. http://localhost:8080)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;" />
                    <button id="autoDetectBtn" type="button" style="background:#28a745;">Auto-Detect</button>
                    <button id="saveBackendBtn" type="button">Manual Test</button>
                </div>
                <small style="display:block; margin-top:8px; color:#555;">Click "Auto-Detect" to find backend automatically. Works with tunnels, gateways, and localhost.</small>
                <div id="backendStatus" style="margin-top:10px; font-size:0.9em; color:#333;">Click Auto-Detect to connect...</div>
            </div>

            <div class="status-card">
                <h3>üî• System Status</h3>
                <div id="statusContent" class="loading">Loading system status...</div>
            </div>

            <div class="endpoints">
                <h3>üì° Available API Endpoints</h3>
                <ul class="endpoint-list">
                    <li>
                        <span>GET /health</span>
                        <button onclick="testEndpoint('/health')">Test</button>
                    </li>
                    <li>
                        <span>GET /</span>
                        <button onclick="testEndpoint('/')">Test</button>
                    </li>
                    <li>
                        <span>GET /docs</span>
                        <button onclick="window.open(API_BASE + '/docs', '_blank')">Open Swagger UI</button>
                    </li>
                    <li>
                        <span>POST /api/pdfs/upload</span>
                        <button onclick="alert('Use Swagger UI or cURL to upload PDFs')">Info</button>
                    </li>
                    <li>
                        <span>POST /api/chat/question</span>
                        <button onclick="alert('Use Swagger UI or cURL to ask questions')">Info</button>
                    </li>
                </ul>
            </div>

            <div class="status-card" style="margin-top: 20px;">
                <h3>üöÄ Quick Start</h3>
                <p style="margin-bottom: 10px;">To interact with the API:</p>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>Visit <code>/docs</code> for interactive API documentation</li>
                    <li>Use <code>curl</code> or Postman to test endpoints</li>
                    <li>Upload a PDF via <code>POST /api/pdfs/upload</code></li>
                    <li>Ask questions via <code>POST /api/chat/question</code></li>
                    <li>Get language feedback via <code>POST /api/language-feedback</code></li>
                </ol>
            </div>

            <div class="status-card" style="margin-top: 20px;">
                <h3>üìÑ Upload PDF for Learning</h3>
                <form id="uploadForm" style="background:#f8f9fa; padding:20px; border-radius:8px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Step 1: Choose PDF File</label>
                        <input type="file" id="pdfFile" accept="application/pdf" required style="display:none;" />
                        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                            <button type="button" id="chooseFileBtn" style="background:#667eea; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
                                üìÅ Choose PDF from Computer
                            </button>
                            <span id="fileName" style="color:#555; font-size:0.95em; font-style:italic;">No file selected</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Step 2: OCR Settings</label>
                        <label style="display:inline-flex; align-items:center; cursor:pointer; background:white; padding:10px; border-radius:6px;">
                            <input type="checkbox" id="enableOcr" style="margin-right:10px; width:20px; height:20px; cursor:pointer;" />
                            <span style="color:#333;">Enable OCR (for scanned/image-based PDFs)</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Step 3: User Identification</label>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <input type="text" id="userId" placeholder="Enter or generate UUID" style="flex:1; min-width:250px; padding:12px; border:2px solid #ddd; border-radius:6px; font-size:0.95em;" required />
                            <button type="button" id="generateUuidBtn" style="background:#6c757d; padding:12px 20px; border-radius:6px; white-space:nowrap;">
                                üé≤ Generate UUID
                            </button>
                        </div>
                    </div>
                    <button type="submit" style="background:#28a745; padding:14px 32px; font-size:1.1em; font-weight:700; border-radius:6px; cursor:pointer; width:100%; max-width:300px;">
                        üöÄ Upload & Process PDF
                    </button>
                </form>
                <div id="uploadResult" style="margin-top: 20px;"></div>
            </div>

            <!-- Chat Interface Section -->
            <div class="status-card" style="margin-top: 30px;">
                <h3>üí¨ Chat with Your PDF</h3>
                <p style="color:#666; margin-bottom:20px; font-size:0.95em;">Ask questions about your uploaded PDF in a conversational way</p>

                <div style="background:#f8f9fa; padding:25px; border-radius:8px;">
                    <!-- Chat Setup -->
                    <div style="margin-bottom: 20px;">
                        <div style="display:grid; grid-template-columns:1fr auto; gap:10px; margin-bottom:15px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">PDF File ID:</label>
                                <input type="text" id="chatFileId" placeholder="Paste file_id from upload" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;" />
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Language Level:</label>
                                <select id="chatLevel" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;">
                                    <option value="Beginner">Beginner</option>
                                    <option value="Intermediate" selected>Intermediate</option>
                                    <option value="Advanced">Advanced</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="startChatSession()" style="background:#667eea; padding:10px 20px; border-radius:6px; font-weight:600; cursor:pointer; width:100%;">
                            üöÄ Start Chat Session
                        </button>
                    </div>

                    <!-- Chat Messages Container -->
                    <div id="chatContainer" style="display:none;">
                        <div id="chatMessages" style="background:white; border-radius:8px; padding:20px; min-height:400px; max-height:600px; overflow-y:auto; margin-bottom:20px; border:2px solid #ddd;">
                            <!-- Welcome message -->
                            <div style="text-align:center; padding:40px; color:#999;">
                                <h4 style="color:#667eea; margin-bottom:10px;">üëã Welcome to PDF Chat!</h4>
                                <p>Start asking questions about your PDF and I'll help you learn.</p>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="chatInput" placeholder="Type your question here... (press Enter to send)"
                                   style="flex:1; padding:14px; border:2px solid #667eea; border-radius:8px; font-size:1em;"
                                   onkeypress="if(event.key==='Enter') sendChatMessage()" />
                            <button onclick="sendChatMessage()" style="background:#667eea; padding:14px 24px; border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap;">
                                üì§ Send
                            </button>
                            <button onclick="clearChat()" style="background:#6c757d; padding:14px 20px; border-radius:8px; font-weight:600; cursor:pointer;">
                                üóëÔ∏è Clear
                            </button>
                        </div>

                        <!-- Quick Actions -->
                        <div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button onclick="insertQuickQuestion('What is the main topic?')" style="background:#e3f2fd; color:#0277bd; padding:8px 16px; border-radius:20px; font-size:0.9em; cursor:pointer; border:1px solid #0277bd;">
                                üìö Main topic?
                            </button>
                            <button onclick="insertQuickQuestion('Summarize chapter 1')" style="background:#e8f5e9; color:#2e7d32; padding:8px 16px; border-radius:20px; font-size:0.9em; cursor:pointer; border:1px solid #2e7d32;">
                                üìù Summarize
                            </button>
                            <button onclick="insertQuickQuestion('What are the key points?')" style="background:#fff3e0; color:#e65100; padding:8px 16px; border-radius:20px; font-size:0.9em; cursor:pointer; border:1px solid #e65100;">
                                üéØ Key points?
                            </button>
                            <button onclick="insertQuickQuestion('Explain this in simple terms')" style="background:#f3e5f5; color:#6a1b9a; padding:8px 16px; border-radius:20px; font-size:0.9em; cursor:pointer; border:1px solid #6a1b9a;">
                                üí° Simplify
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Task Selector Section -->
            <div class="status-card" style="margin-top: 30px;">
                <h3>ü§ñ AI Agent Task Selector</h3>
                <p style="color:#666; margin-bottom:20px; font-size:0.95em;">Choose which AI agent to use for your task</p>

                <div style="background:#f8f9fa; padding:25px; border-radius:8px;">
                    <!-- Agent Selection -->
                    <div style="margin-bottom: 25px;">
                        <label style="display:block; margin-bottom:10px; font-weight:600; color:#333; font-size:1.05em;">
                            Select Agent Task:
                        </label>
                        <select id="agentSelector" style="width:100%; padding:14px; border:2px solid #667eea; border-radius:8px; font-size:1em; cursor:pointer; background:white;">
                            <option value="">-- Choose an AI Agent Task --</option>
                            <option value="qa">üí¨ Ask Question (QA Agent)</option>
                            <option value="language-feedback">üéì Get Language Feedback (Language Coach)</option>
                            <option value="translate">üåç Translate Content (Translator Agent)</option>
                            <option value="report">üìä Generate Learning Report (Reporter Agent)</option>
                            <option value="topics">üìö View Extracted Topics (Extraction Agent)</option>
                        </select>
                    </div>

                    <!-- Dynamic Input Area -->
                    <div id="agentInputArea" style="display:none;">
                        <!-- QA Agent Interface -->
                        <div id="qaInterface" class="agent-interface" style="display:none;">
                            <h4 style="color:#667eea; margin-bottom:15px;">üí¨ Ask Question About PDF</h4>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">PDF File ID:</label>
                                <input type="text" id="qaFileId" placeholder="Enter file_id from upload" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;" />
                                <small style="color:#666; font-size:0.85em;">Paste the file_id you received after uploading PDF</small>
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Your Question:</label>
                                <textarea id="qaQuestion" placeholder="What is the main topic of this PDF?" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px; min-height:100px; font-family:inherit;"></textarea>
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Your Language Level:</label>
                                <select id="qaLevel" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;">
                                    <option value="Beginner">Beginner</option>
                                    <option value="Intermediate" selected>Intermediate</option>
                                    <option value="Advanced">Advanced</option>
                                </select>
                            </div>
                            <button onclick="executeQAAgent()" style="background:#667eea; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
                                üöÄ Ask Question
                            </button>
                        </div>

                        <!-- Language Feedback Interface -->
                        <div id="feedbackInterface" class="agent-interface" style="display:none;">
                            <h4 style="color:#667eea; margin-bottom:15px;">üéì Get Language Learning Feedback</h4>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Your Sentence/Text:</label>
                                <textarea id="feedbackText" placeholder="I is going to school..." style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px; min-height:100px; font-family:inherit;"></textarea>
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Target Language:</label>
                                <select id="feedbackLanguage" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="hi">Hindi</option>
                                </select>
                            </div>
                            <button onclick="executeLanguageFeedback()" style="background:#28a745; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
                                ‚úÖ Get Feedback
                            </button>
                        </div>

                        <!-- Translation Interface -->
                        <div id="translateInterface" class="agent-interface" style="display:none;">
                            <h4 style="color:#667eea; margin-bottom:15px;">üåç Translate PDF Content</h4>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">PDF File ID:</label>
                                <input type="text" id="translateFileId" placeholder="Enter file_id from upload" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;" />
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Target Language:</label>
                                <select id="translateLanguage" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;">
                                    <option value="es">Spanish (Espa√±ol)</option>
                                    <option value="fr">French (Fran√ßais)</option>
                                    <option value="de">German (Deutsch)</option>
                                    <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                                    <option value="zh">Chinese (‰∏≠Êñá)</option>
                                    <option value="ja">Japanese (Êó•Êú¨Ë™û)</option>
                                    <option value="pt">Portuguese (Portugu√™s)</option>
                                </select>
                            </div>
                            <button onclick="executeTranslate()" style="background:#fd7e14; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
                                üåê Translate
                            </button>
                        </div>

                        <!-- Report Interface -->
                        <div id="reportInterface" class="agent-interface" style="display:none;">
                            <h4 style="color:#667eea; margin-bottom:15px;">üìä Generate Learning Report</h4>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">PDF File ID:</label>
                                <input type="text" id="reportFileId" placeholder="Enter file_id from upload" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;" />
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">User ID (optional):</label>
                                <input type="text" id="reportUserId" placeholder="Your UUID (for personalized report)" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;" />
                            </div>
                            <button onclick="executeReport()" style="background:#dc3545; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
                                üìà Generate Report
                            </button>
                        </div>

                        <!-- Topics Interface -->
                        <div id="topicsInterface" class="agent-interface" style="display:none;">
                            <h4 style="color:#667eea; margin-bottom:15px;">üìö View Extracted Topics</h4>
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">PDF File ID:</label>
                                <input type="text" id="topicsFileId" placeholder="Enter file_id from upload" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:6px;" />
                            </div>
                            <button onclick="executeTopics()" style="background:#6c757d; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
                                üìñ View Topics
                            </button>
                        </div>
                    </div>

                    <!-- Results Area -->
                    <div id="agentResults" style="margin-top:25px; display:none;">
                        <div style="background:white; padding:20px; border-radius:8px; border-left:4px solid #667eea;">
                            <h4 style="color:#333; margin-bottom:15px;">üìã Agent Response:</h4>
                            <div id="agentResultContent" style="white-space:pre-wrap; color:#333; line-height:1.6;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend API base resolution
        function deriveDefaultBackendBase() {
            // Try same hostname on port 8080
            return window.location.protocol + '//' + window.location.hostname + ':8080';
        }
        const storedBase = localStorage.getItem('backend_base');
        let API_BASE = storedBase || deriveDefaultBackendBase();
        const backendUrlInput = document.getElementById('backendUrlInput');
        if (backendUrlInput) backendUrlInput.value = API_BASE;
        const backendStatusEl = document.getElementById('backendStatus');

        function setBackendBase(newBase) {
            API_BASE = newBase.replace(/\/$/, '');
            localStorage.setItem('backend_base', API_BASE);
        }

        document.getElementById('saveBackendBtn').addEventListener('click', () => {
            const val = backendUrlInput.value.trim();
            if (!val) return;
            setBackendBase(val);
            backendStatusEl.textContent = 'Testing ' + API_BASE + ' ...';
            testBackendHealth();
        });

        // Auto-detect button handler
        document.getElementById('autoDetectBtn').addEventListener('click', async () => {
            backendStatusEl.innerHTML = '<span style="color:#0066cc;">üîç Auto-detecting...</span>';
            const candidates = [
                'http://localhost:8080',
                window.location.protocol + '//' + window.location.hostname + ':8080'
            ];
            const unique = [...new Set(candidates)];

            for (const url of unique) {
                try {
                    backendStatusEl.innerHTML = '<span style="color:#0066cc;">üîç Trying ' + url + '...</span>';
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);

                    // Try /health endpoint first
                    try {
                        const resp = await fetch(url + '/health', {mode:'cors', signal: controller.signal});
                        clearTimeout(timeoutId);
                        if (resp.ok) {
                            const data = await resp.json();
                            setBackendBase(url);
                            backendUrlInput.value = url;
                            backendStatusEl.innerHTML = '<span style="color:green;">‚úÖ Connected:</span> ' + url;
                            renderStatus(data);
                            return;
                        }
                    } catch (e) {
                        // health check failed, try next candidate
                    }

                    // Try /openapi.json as fallback
                    try {
                        const respOpenAPI = await fetch(url + '/openapi.json', {mode:'cors', signal: controller.signal});
                        clearTimeout(timeoutId);
                        if (respOpenAPI.ok) {
                            // OpenAPI found, backend exists; now check health
                            const healthResp = await fetch(url + '/health', {mode:'cors'});
                            if (healthResp.ok) {
                                const data = await healthResp.json();
                                setBackendBase(url);
                                backendUrlInput.value = url;
                                backendStatusEl.innerHTML = '<span style="color:green;">‚úÖ Connected:</span> ' + url;
                                renderStatus(data);
                                return;
                            }
                        }
                    } catch (e) {
                        // openapi.json check failed, try next candidate
                    }

                    clearTimeout(timeoutId);
                } catch (e) {
                    continue;
                }
            }
            backendStatusEl.innerHTML = '<span style="color:#b30000;">‚ùå Failed</span> - Enter URL manually';
            document.getElementById('statusContent').innerHTML = '<p style="color:#b30000;">Backend not found. Enter URL manually.</p>';
        });

        async function fetchWithRetry(url, options = {}, retries = 3, delayMs = 800) {
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const resp = await fetch(url, options);
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    return resp;
                } catch (err) {
                    if (attempt === retries) throw err;
                    await new Promise(r => setTimeout(r, delayMs * (attempt + 1)));
                }
            }
        }

        async function testBackendHealth() {
            try {
                const resp = await fetchWithRetry(API_BASE + '/health', {mode:'cors'}, 2);
                const data = await resp.json();
                backendStatusEl.innerHTML = '<span style="color:green;">‚úÖ Connected</span> ' + API_BASE + ' | Agents: ' + data.agents_active + ' | Vector: ' + data.services.vector_store;
                renderStatus(data);
            } catch (e) {
                backendStatusEl.innerHTML = '<span style="color:#b30000;">‚ùå Failed:</span> ' + e.message + ' (URL: ' + API_BASE + '/health)';
                // Show error block in system status
                const statusContent = document.getElementById('statusContent');
                if (statusContent) {
                    statusContent.innerHTML = '<p style="color:#b30000;">Failed to load status: ' + e.message + '<br/>Check port forwarding or update backend URL above.</p>';
                }
            }
        }

        function renderStatus(data) {
            if (!data) return;
            const statusContent = document.getElementById('statusContent');
            if (!statusContent) return;
            let html = `
                <div class="status-grid">
                    <div class="status-item"><h4>Overall Status</h4><p><span class="badge ${data.status}">${data.status.toUpperCase()}</span></p></div>
                    <div class="status-item"><h4>Agents Active</h4><p>${data.agents_active}</p></div>
                    <div class="status-item"><h4>Environment</h4><p>${data.environment}</p></div>
                </div>
                <h4 style="margin-top:20px;margin-bottom:10px;">Services:</h4>
                <div class="status-grid">
                    ${Object.entries(data.services).map(([svc, st]) => `
                        <div class="status-item"><h4>${svc.replace('_',' ').toUpperCase()}</h4><p><span class="badge ${st}">${st}</span></p></div>
                    `).join('')}
                </div>
            `;
            if (data.gemini_quota) {
                html += `
                    <h4 style="margin-top:20px;margin-bottom:10px;">Gemini Quota:</h4>
                    <div class="status-grid">
                        <div class="status-item"><h4>Remaining</h4><p>${data.gemini_quota.requests_remaining}/${data.gemini_quota.max_requests_per_minute}</p></div>
                        <div class="status-item"><h4>Model</h4><p>${data.gemini_quota.model}</p></div>
                    </div>
                `;
            }
            statusContent.innerHTML = html;
        }

        async function loadStatus() {
            // Only attempt automatically once; subsequent manual tests via button
            await testBackendHealth();
        }

        async function testEndpoint(endpoint) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Testing...';

            try {
                const response = await fetch(API_BASE + endpoint, { mode: 'cors' });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                alert('‚úÖ Success!\n\nEndpoint: ' + API_BASE + endpoint + '\n\nResponse:\n' + JSON.stringify(data, null, 2).substring(0, 500));
            } catch (error) {
                alert('‚ùå Error!\n\nEndpoint: ' + API_BASE + endpoint + '\n\nError: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // File chooser button handler
        // File chooser button handler
        const chooseFileBtn = document.getElementById('chooseFileBtn');
        const pdfFileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileName');

        if (chooseFileBtn && pdfFileInput && fileNameDisplay) {
            chooseFileBtn.addEventListener('click', () => {
                pdfFileInput.click();
            });

            pdfFileInput.addEventListener('change', () => {
                const file = pdfFileInput.files && pdfFileInput.files[0];
                if (file) {
                    fileNameDisplay.textContent = '‚úì ' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
                    fileNameDisplay.style.color = '#28a745';
                    fileNameDisplay.style.fontWeight = '600';
                } else {
                    fileNameDisplay.textContent = 'No file selected';
                    fileNameDisplay.style.color = '#555';
                    fileNameDisplay.style.fontWeight = 'normal';
                }
            });
        }

        // UUID generator
        const generateUuidBtn = document.getElementById('generateUuidBtn');
        const userIdInput = document.getElementById('userId');
        if (generateUuidBtn && userIdInput) {
            generateUuidBtn.addEventListener('click', () => {
                // Simple UUID v4 generator
                const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                userIdInput.value = uuid;
            });
        }

        // Upload form handler
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('pdfFile');
                const userIdInput = document.getElementById('userId');
                const enableOcrInput = document.getElementById('enableOcr');
                const resultEl = document.getElementById('uploadResult');
                if (!fileInput || !userIdInput || !enableOcrInput) return;
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    resultEl.innerHTML = '<p style="color:red; background:#ffe6e6; padding:10px; border-radius:5px;">‚ùå Please select a PDF file first.</p>';
                    return;
                }
                if (!userIdInput.value.trim()) {
                    resultEl.innerHTML = '<p style="color:red; background:#ffe6e6; padding:10px; border-radius:5px;">‚ùå Please enter a User ID or click Generate UUID.</p>';
                    return;
                }
                const fd = new FormData();
                fd.append('file', file);
                fd.append('user_id', userIdInput.value.trim());
                fd.append('language', '');
                fd.append('enable_ocr', enableOcrInput.checked ? 'true' : 'false');
                resultEl.innerHTML = '<p style="color:#0066cc; background:#e6f2ff; padding:10px; border-radius:5px;">‚è≥ Uploading and processing... This may take 10-30 seconds.</p>';
                try {
                    const resp = await fetch(API_BASE + '/api/pdfs/upload', { method:'POST', body: fd });
                    if (!resp.ok) {
                        const errorText = await resp.text();
                        throw new Error('Upload failed: HTTP ' + resp.status + ' - ' + errorText.substring(0, 100));
                    }
                    const data = await resp.json();

                    // Store current PDF globally
                    currentPDF = {
                        file_id: data.file_id,
                        filename: data.filename,
                        pages: data.total_pages,
                        language: data.detected_language,
                        user_id: userIdInput.value.trim()
                    };

                    resultEl.innerHTML = '<div style="background:#d4edda; padding:15px; border-radius:5px; border-left:4px solid #28a745;">' +
                        '<h4 style="color:#155724; margin-bottom:10px;">‚úÖ Upload Successful!</h4>' +
                        '<p><strong>Filename:</strong> ' + data.filename + '</p>' +
                        '<p><strong>Pages:</strong> ' + data.total_pages + '</p>' +
                        '<p><strong>Language:</strong> ' + data.detected_language + '</p>' +
                        '<p><strong>Status:</strong> ' + data.status + '</p>' +
                        '<p style="margin-top:10px; color:#555;"><em>' + data.message + '</em></p>' +
                        '<div style="margin-top:15px; padding:12px; background:#fff3cd; border-radius:6px; border-left:3px solid #ffc107;">' +
                        '<strong style="color:#856404;">üí¨ Ready to Chat!</strong><br>' +
                        '<span style="color:#856404; font-size:0.95em;">Scroll down to "Chat with Your PDF" to start asking questions.</span>' +
                        '</div>' +
                        '</div>';

                    // Update current PDF display
                    if (typeof updateCurrentPdfDisplay === 'function') {
                        updateCurrentPdfDisplay();
                    }

                    // Reset form (but keep user_id)
                    pdfFileInput.value = '';
                    enableOcrInput.checked = false;
                    fileNameDisplay.textContent = 'No file selected';
                    fileNameDisplay.style.color = '#555';
                    fileNameDisplay.style.fontWeight = 'normal';

                    // Scroll to chat section after 1 second
                    setTimeout(() => {
                        const chatSection = document.querySelector('#currentPdfDisplay');
                        if (chatSection) {
                            chatSection.closest('.status-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 1000);
                } catch (err) {
                    resultEl.innerHTML = '<div style="background:#f8d7da; padding:15px; border-radius:5px; border-left:4px solid #dc3545;">' +
                        '<h4 style="color:#721c24; margin-bottom:10px;">‚ùå Upload Failed</h4>' +
                        '<p style="color:#721c24;">' + err.message + '</p>' +
                        '<p style="margin-top:10px; font-size:0.9em; color:#555;">Make sure backend is connected (check Backend Connection panel above).</p>' +
                        '</div>';
                }
            });
        }

        // Q&A Form Handler
        const qaForm = document.getElementById('qaForm');
        if (qaForm) {
            qaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resultEl = document.getElementById('qaResult');
                const fileId = document.getElementById('qaFileId').value.trim();
                const question = document.getElementById('qaQuestion').value.trim();
                const level = document.getElementById('qaLevel').value;

                resultEl.innerHTML = '<p style="color:#0066cc; background:#e6f2ff; padding:10px; border-radius:5px;">‚è≥ Getting answer...</p>';

                try {
                    const resp = await fetch(API_BASE + '/api/chat/question', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            file_id: fileId,
                            user_id: userIdInput.value || '00000000-0000-0000-0000-000000000000',
                            question: question,
                            language: 'English',
                            user_language_level: level
                        })
                    });

                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();

                    resultEl.innerHTML = '<div style="background:#e8f5e9; padding:15px; border-radius:5px; border-left:4px solid #4caf50;">' +
                        '<h4 style="color:#2e7d32; margin-bottom:10px;">üí° Answer:</h4>' +
                        '<p style="white-space:pre-wrap;">' + data.answer + '</p>' +
                        (data.source_section ? '<p style="margin-top:10px;"><strong>Source:</strong> ' + data.source_section + (data.page_number ? ' (Page ' + data.page_number + ')' : '') + '</p>' : '') +
                        (data.confidence_score ? '<p><strong>Confidence:</strong> ' + (data.confidence_score * 100).toFixed(0) + '%</p>' : '') +
                        '</div>';
                } catch (err) {
                    resultEl.innerHTML = '<div style="background:#ffebee; padding:15px; border-radius:5px; border-left:4px solid #f44336;">' +
                        '<h4 style="color:#c62828;">‚ùå Error</h4><p>' + err.message + '</p></div>';
                }
            });
        }

        // Language Feedback Form Handler
        const feedbackForm = document.getElementById('feedbackForm');
        if (feedbackForm) {
            feedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resultEl = document.getElementById('feedbackResult');
                const sentence = document.getElementById('userSentence').value.trim();
                const context = document.getElementById('feedbackContext').value.trim();

                resultEl.innerHTML = '<p style="color:#0066cc; background:#e6f2ff; padding:10px; border-radius:5px;">‚è≥ Analyzing...</p>';

                try {
                    const resp = await fetch(API_BASE + '/api/language-feedback', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            pdf_id: '00000000-0000-0000-0000-000000000000',
                            user_id: userIdInput.value || '00000000-0000-0000-0000-000000000000',
                            user_output: sentence,
                            correct_form: '',
                            context: context
                        })
                    });

                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();

                    let html = '<div style="background:#fff3e0; padding:15px; border-radius:5px; border-left:4px solid #ff9800;">';
                    html += '<h4 style="color:#e65100; margin-bottom:10px;">‚úèÔ∏è Feedback:</h4>';

                    if (data.grammar_feedback) {
                        html += '<p><strong>Grammar:</strong> ' + data.grammar_feedback + '</p>';
                    }

                    if (data.vocabulary_suggestions && data.vocabulary_suggestions.length > 0) {
                        html += '<p style="margin-top:10px;"><strong>Vocabulary Suggestions:</strong></p><ul style="margin-left:20px;">';
                        data.vocabulary_suggestions.forEach(s => {
                            html += '<li>' + s.original + ' ‚Üí ' + (s.suggestions ? s.suggestions.join(', ') : '') +
                                   (s.explanation ? ' (' + s.explanation + ')' : '') + '</li>';
                        });
                        html += '</ul>';
                    }

                    if (data.fluency_notes) {
                        html += '<p style="margin-top:10px;"><strong>Fluency:</strong> ' + data.fluency_notes + '</p>';
                    }

                    if (data.encouragement) {
                        html += '<p style="margin-top:10px; color:#2e7d32;"><strong>üí™ ' + data.encouragement + '</strong></p>';
                    }

                    html += '</div>';
                    resultEl.innerHTML = html;
                } catch (err) {
                    resultEl.innerHTML = '<div style="background:#ffebee; padding:15px; border-radius:5px; border-left:4px solid #f44336;">' +
                        '<h4 style="color:#c62828;">‚ùå Error</h4><p>' + err.message + '</p></div>';
                }
            });
        }

        // Translation Form Handler
        const translateForm = document.getElementById('translateForm');
        if (translateForm) {
            translateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resultEl = document.getElementById('translateResult');
                const fileId = document.getElementById('translateFileId').value.trim();
                const targetLang = document.getElementById('targetLanguage').value;

                resultEl.innerHTML = '<p style="color:#0066cc; background:#e6f2ff; padding:10px; border-radius:5px;">‚è≥ Translating...</p>';

                try {
                    const resp = await fetch(API_BASE + '/api/translate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            file_id: fileId,
                            target_language: targetLang,
                            include_pronunciation: true
                        })
                    });

                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();

                    let html = '<div style="background:#e3f2fd; padding:15px; border-radius:5px; border-left:4px solid #2196F3;">';
                    html += '<h4 style="color:#0d47a1; margin-bottom:10px;">üåç Translations:</h4>';

                    if (data.translated_topics && data.translated_topics.length > 0) {
                        html += '<div style="margin-top:10px;">';
                        data.translated_topics.forEach(t => {
                            html += '<div style="background:white; padding:10px; margin-bottom:10px; border-radius:4px;">';
                            html += '<p><strong>Original:</strong> ' + (t.original_name || t.original_description || '') + '</p>';
                            html += '<p><strong>Translation:</strong> ' + (t.translated_name || t.translated_description || '') + '</p>';
                            if (t.pronunciation) {
                                html += '<p style="color:#666;"><em>Pronunciation: ' + t.pronunciation + '</em></p>';
                            }
                            html += '</div>';
                        });
                        html += '</div>';
                    } else {
                        html += '<p>No translations available.</p>';
                    }

                    html += '</div>';
                    resultEl.innerHTML = html;
                } catch (err) {
                    resultEl.innerHTML = '<div style="background:#ffebee; padding:15px; border-radius:5px; border-left:4px solid #f44336;">' +
                        '<h4 style="color:#c62828;">‚ùå Error</h4><p>' + err.message + '</p></div>';
                }
            });
        }

        // Report Form Handler
        const reportForm = document.getElementById('reportForm');
        if (reportForm) {
            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resultEl = document.getElementById('reportResult');
                const fileId = document.getElementById('reportFileId').value.trim();
                const userId = document.getElementById('reportUserId').value.trim();

                resultEl.innerHTML = '<p style="color:#0066cc; background:#e6f2ff; padding:10px; border-radius:5px;">‚è≥ Generating report...</p>';

                try {
                    const resp = await fetch(API_BASE + '/api/reports/' + fileId + '?user_id=' + userId, {
                        method: 'GET'
                    });

                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();

                    let html = '<div style="background:#f3e5f5; padding:15px; border-radius:5px; border-left:4px solid #9c27b0;">';
                    html += '<h4 style="color:#4a148c; margin-bottom:10px;">üìä Learning Report:</h4>';

                    if (data.summary) {
                        html += '<p><strong>Summary:</strong> ' + data.summary + '</p>';
                    }

                    if (data.accuracy_percentage !== undefined) {
                        html += '<p style="margin-top:10px;"><strong>Accuracy:</strong> ' + data.accuracy_percentage.toFixed(1) + '%</p>';
                    }

                    if (data.total_sessions) {
                        html += '<p><strong>Total Sessions:</strong> ' + data.total_sessions + '</p>';
                    }

                    if (data.total_mistakes) {
                        html += '<p><strong>Total Mistakes:</strong> ' + data.total_mistakes + '</p>';
                    }

                    if (data.learning_gaps && data.learning_gaps.length > 0) {
                        html += '<p style="margin-top:10px;"><strong>Learning Gaps:</strong></p><ul style="margin-left:20px;">';
                        data.learning_gaps.forEach(g => {
                            html += '<li>' + g.topic + ': ' + g.description + ' (' + g.severity + ')</li>';
                        });
                        html += '</ul>';
                    }

                    if (data.recommendations && data.recommendations.length > 0) {
                        html += '<p style="margin-top:10px;"><strong>Recommendations:</strong></p><ul style="margin-left:20px;">';
                        data.recommendations.forEach(r => {
                            html += '<li>' + r + '</li>';
                        });
                        html += '</ul>';
                    }

                    html += '</div>';
                    resultEl.innerHTML = html;
                } catch (err) {
                    resultEl.innerHTML = '<div style="background:#ffebee; padding:15px; border-radius:5px; border-left:4px solid #f44336;">' +
                        '<h4 style="color:#c62828;">‚ùå Error</h4><p>' + err.message + '</p></div>';
                }
            });
        }

        // Initial load - trigger auto-detect automatically
        document.getElementById('autoDetectBtn').click();
        // ============================================================
        // AGENT SELECTOR FUNCTIONS
        // ============================================================

        // Handle agent selection dropdown
        document.getElementById('agentSelector').addEventListener('change', function() {
            const selectedAgent = this.value;
            const inputArea = document.getElementById('agentInputArea');
            const allInterfaces = document.querySelectorAll('.agent-interface');

            // Hide all interfaces first
            allInterfaces.forEach(iface => iface.style.display = 'none');

            // Hide results when switching agents
            document.getElementById('agentResults').style.display = 'none';

            if (selectedAgent === '') {
                inputArea.style.display = 'none';
                return;
            }

            // Show input area and specific interface
            inputArea.style.display = 'block';

            switch(selectedAgent) {
                case 'qa':
                    document.getElementById('qaInterface').style.display = 'block';
                    break;
                case 'language-feedback':
                    document.getElementById('feedbackInterface').style.display = 'block';
                    break;
                case 'translate':
                    document.getElementById('translateInterface').style.display = 'block';
                    break;
                case 'report':
                    document.getElementById('reportInterface').style.display = 'block';
                    break;
                case 'topics':
                    document.getElementById('topicsInterface').style.display = 'block';
                    break;
            }
        });

        // QA Agent Execution
        async function executeQAAgent() {
            const fileId = document.getElementById('qaFileId').value.trim();
            const question = document.getElementById('qaQuestion').value.trim();
            const level = document.getElementById('qaLevel').value;

            if (!fileId || !question) {
                alert('‚ùå Please fill in all required fields');
                return;
            }

            showAgentResult('Processing... üîÑ');

            try {
                const response = await fetch(API_BASE + '/api/chat/question', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_id: fileId,
                        question: question,
                        language_level: level
                    })
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                let html = `
<div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#2e7d32; margin-bottom:10px;">‚úÖ Answer:</h4>
    <p style="font-size:1.05em; line-height:1.6;">${data.answer}</p>
</div>
<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:10px; margin-top:15px;">
    <div style="background:#fff3e0; padding:10px; border-radius:6px;">
        <strong>üìÑ Source Page:</strong> ${data.source_page || 'N/A'}
    </div>
    <div style="background:#e3f2fd; padding:10px; border-radius:6px;">
        <strong>üéØ Confidence:</strong> ${(data.confidence * 100).toFixed(1)}%
    </div>
    <div style="background:#f3e5f5; padding:10px; border-radius:6px;">
        <strong>üìä Level:</strong> ${data.language_level || level}
    </div>
</div>`;

                showAgentResult(html);
            } catch (error) {
                showAgentResult('‚ùå Error: ' + error.message, true);
            }
        }

        // Language Feedback Agent Execution
        async function executeLanguageFeedback() {
            const text = document.getElementById('feedbackText').value.trim();
            const language = document.getElementById('feedbackLanguage').value;

            if (!text) {
                alert('‚ùå Please enter text to analyze');
                return;
            }

            showAgentResult('Analyzing your language... üîÑ');

            try {
                const response = await fetch(API_BASE + '/api/language-feedback', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_output: text,
                        language: language
                    })
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                let html = `
<div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#856404;">üìù Your Text:</h4>
    <p style="font-style:italic;">"${text}"</p>
</div>`;

                if (data.grammar_feedback) {
                    html += `
<div style="background:#f8d7da; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#721c24;">‚úèÔ∏è Grammar Feedback:</h4>
    <p>${data.grammar_feedback}</p>
</div>`;
                }

                if (data.vocabulary_suggestions && data.vocabulary_suggestions.length > 0) {
                    html += `
<div style="background:#d1ecf1; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#0c5460;">üìö Vocabulary Suggestions:</h4>
    <ul style="margin-left:20px;">`;
                    data.vocabulary_suggestions.forEach(suggestion => {
                        html += `<li>${typeof suggestion === 'string' ? suggestion : (suggestion.word || suggestion)}</li>`;
                    });
                    html += `</ul>
</div>`;
                }

                if (data.fluency_notes) {
                    html += `
<div style="background:#d4edda; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#155724;">üí¨ Fluency Notes:</h4>
    <p>${data.fluency_notes}</p>
</div>`;
                }

                if (data.encouragement) {
                    html += `
<div style="background:#e7f3ff; padding:15px; border-radius:8px; border-left:4px solid #0066cc;">
    <h4 style="color:#0066cc;">üí™ Encouragement:</h4>
    <p><strong>${data.encouragement}</strong></p>
</div>`;
                }

                showAgentResult(html);
            } catch (error) {
                showAgentResult('‚ùå Error: ' + error.message, true);
            }
        }

        // Translator Agent Execution
        async function executeTranslate() {
            const fileId = document.getElementById('translateFileId').value.trim();
            const targetLanguage = document.getElementById('translateLanguage').value;

            if (!fileId) {
                alert('‚ùå Please enter file ID');
                return;
            }

            showAgentResult('Translating content... üîÑ');

            try {
                const response = await fetch(API_BASE + '/api/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_id: fileId,
                        target_language: targetLanguage
                    })
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                let html = `
<div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#2e7d32;">üåç Translation Complete!</h4>
    <p><strong>Target Language:</strong> ${targetLanguage.toUpperCase()}</p>
</div>`;

                if (data.translated_topics && data.translated_topics.length > 0) {
                    html += `
<div style="background:white; padding:15px; border-radius:8px; border:2px solid #ddd;">
    <h4 style="color:#333; margin-bottom:10px;">üìö Translated Topics:</h4>`;
                    data.translated_topics.forEach((topic, idx) => {
                        html += `
    <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:6px;">
        <strong>${idx + 1}. ${topic.name || topic.translated_name || 'Topic'}</strong>
        <p style="margin-top:5px; color:#666;">${topic.description || topic.translated_description || ''}</p>
    </div>`;
                    });
                    html += `</div>`;
                }

                if (data.translated) {
                    html += `
<div style="background:#fff3e0; padding:15px; border-radius:8px; margin-top:15px;">
    <h4 style="color:#e65100;">üìÑ Translated Content:</h4>
    <p style="white-space:pre-wrap;">${data.translated}</p>
</div>`;
                }

                showAgentResult(html);
            } catch (error) {
                showAgentResult('‚ùå Error: ' + error.message, true);
            }
        }

        // Report Agent Execution
        async function executeReport() {
            const fileId = document.getElementById('reportFileId').value.trim();
            const userId = document.getElementById('reportUserId').value.trim();

            if (!fileId) {
                alert('‚ùå Please enter file ID');
                return;
            }

            showAgentResult('Generating learning report... üîÑ');

            try {
                let url = API_BASE + '/api/reports/' + fileId;
                if (userId) url += '?user_id=' + userId;

                const response = await fetch(url, { method: 'GET' });

                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                let html = `
<div style="background:#e3f2fd; padding:20px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#0277bd; margin-bottom:10px;">üìä Learning Report</h4>
    <p style="font-size:1.05em;">${data.summary || 'Report generated successfully'}</p>
</div>`;

                if (data.accuracy !== undefined) {
                    const accuracyColor = data.accuracy >= 80 ? '#2e7d32' : data.accuracy >= 60 ? '#f57c00' : '#c62828';
                    html += `
<div style="background:#f1f8e9; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:${accuracyColor};">üéØ Accuracy: ${data.accuracy}%</h4>
    <div style="background:#ddd; height:20px; border-radius:10px; margin-top:10px; overflow:hidden;">
        <div style="background:${accuracyColor}; height:100%; width:${data.accuracy}%; transition:width 0.5s;"></div>
    </div>
</div>`;
                }

                if (data.learning_gaps && data.learning_gaps.length > 0) {
                    html += `
<div style="background:#fff3e0; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#e65100;">‚ö†Ô∏è Learning Gaps:</h4>
    <ul style="margin-left:20px;">`;
                    data.learning_gaps.forEach(gap => {
                        html += `<li style="margin:5px 0;">${gap}</li>`;
                    });
                    html += `</ul>
</div>`;
                }

                if (data.recommendations && data.recommendations.length > 0) {
                    html += `
<div style="background:#e8f5e9; padding:15px; border-radius:8px;">
    <h4 style="color:#2e7d32;">üí° Recommendations:</h4>
    <ol style="margin-left:20px;">`;
                    data.recommendations.forEach(rec => {
                        html += `<li style="margin:8px 0;">${rec}</li>`;
                    });
                    html += `</ol>
</div>`;
                }

                showAgentResult(html);
            } catch (error) {
                showAgentResult('‚ùå Error: ' + error.message, true);
            }
        }

        // Topics Agent Execution
        async function executeTopics() {
            const fileId = document.getElementById('topicsFileId').value.trim();

            if (!fileId) {
                alert('‚ùå Please enter file ID');
                return;
            }

            showAgentResult('Fetching topics... üîÑ');

            try {
                const response = await fetch(API_BASE + '/api/pdfs/' + fileId + '/topics');

                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                let html = `
<div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px;">
    <h4 style="color:#0277bd;">üìö Extracted Topics</h4>
    <p>Found ${data.topics ? data.topics.length : 0} topics</p>
</div>`;

                if (data.topics && data.topics.length > 0) {
                    data.topics.forEach((topic, idx) => {
                        html += `
<div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #667eea; margin-bottom:15px;">
    <h4 style="color:#667eea; margin-bottom:8px;">${idx + 1}. ${topic.topic_name || topic.name || 'Topic'}</h4>
    <p style="color:#666; margin-bottom:10px;">${topic.description || 'No description'}</p>
    ${topic.difficulty ? `<span class="badge" style="background:#e3f2fd; color:#0277bd; padding:4px 10px; border-radius:12px; font-size:0.85em;">Difficulty: ${topic.difficulty}</span>` : ''}
    ${topic.page_number ? `<span class="badge" style="background:#f3e5f5; color:#6a1b9a; padding:4px 10px; border-radius:12px; font-size:0.85em; margin-left:8px;">Page: ${topic.page_number}</span>` : ''}
</div>`;
                    });
                } else {
                    html += `
<div style="background:#fff3cd; padding:15px; border-radius:8px;">
    <p style="color:#856404;">‚ÑπÔ∏è No topics found. The PDF may need to be re-processed.</p>
</div>`;
                }

                showAgentResult(html);
            } catch (error) {
                showAgentResult('‚ùå Error: ' + error.message, true);
            }
        }

        // Helper function to display agent results
        function showAgentResult(content, isError = false) {
            const resultsDiv = document.getElementById('agentResults');
            const contentDiv = document.getElementById('agentResultContent');

            resultsDiv.style.display = 'block';

            if (isError) {
                resultsDiv.querySelector('div').style.borderLeft = '4px solid #dc3545';
                contentDiv.innerHTML = `<div style="color:#dc3545; font-weight:600;">${content}</div>`;
            } else {
                resultsDiv.querySelector('div').style.borderLeft = '4px solid #667eea';
                contentDiv.innerHTML = content;
            }

            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ============================================================
        // CHAT INTERFACE FUNCTIONS
        // ============================================================

        let chatSessionActive = false;
        let chatFileId = '';
        let chatLanguageLevel = 'Intermediate';


        // Start chat session
        function startChatSession() {
            const fileIdInput = document.getElementById('chatFileId');
            const levelSelect = document.getElementById('chatLevel');

            chatFileId = fileIdInput.value.trim();
            chatLanguageLevel = levelSelect.value;

            if (!chatFileId) {
                alert('‚ùå Please enter a PDF file ID first!\n\nUpload a PDF and copy the file_id from the response.');
                return;
            }

            // Show chat container
            document.getElementById('chatContainer').style.display = 'block';
            chatSessionActive = true;

            // Add welcome message
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = `
                <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #0277bd;">
                    <strong style="color:#0277bd;">ü§ñ AI Assistant:</strong>
                    <p style="margin:5px 0 0 0; color:#333;">Chat session started! I'm ready to answer questions about your PDF. Language level: <strong>${chatLanguageLevel}</strong></p>
                </div>
            `;

            // Focus on input
            document.getElementById('chatInput').focus();

            // Scroll to chat
            document.getElementById('chatContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Send chat message
        async function sendChatMessage() {
            const inputField = document.getElementById('chatInput');
            const question = inputField.value.trim();

            if (!question) {
                return;
            }

            if (!chatSessionActive) {
                alert('‚ùå Please start a chat session first!');
                return;
            }

            // Clear input
            inputField.value = '';

            // Add user message to chat
            addChatMessage('user', question);

            // Add thinking indicator
            const thinkingId = addChatMessage('assistant', 'ü§î Thinking...', true);

            try {
                // Call QA API
                const response = await fetch(API_BASE + '/api/chat/question', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_id: chatFileId,
                        question: question,
                        language_level: chatLanguageLevel
                    })
                });

                // Remove thinking indicator
                document.getElementById(thinkingId).remove();

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const data = await response.json();

                // Add assistant response
                const answerHtml = `
                    <div style="margin-bottom:10px;">
                        <strong>Answer:</strong>
                        <p style="margin:5px 0;">${data.answer}</p>
                    </div>
                    <div style="display:flex; gap:15px; flex-wrap:wrap; font-size:0.85em; color:#666; margin-top:10px;">
                        <span>üìÑ Page: ${data.source_page || 'N/A'}</span>
                        <span>üéØ Confidence: ${(data.confidence * 100).toFixed(0)}%</span>
                        <span>üìä Level: ${data.language_level}</span>
                    </div>
                `;
                addChatMessage('assistant', answerHtml);

            } catch (error) {
                // Remove thinking indicator
                const thinkingEl = document.getElementById(thinkingId);
                if (thinkingEl) thinkingEl.remove();

                addChatMessage('assistant', `‚ùå Error: ${error.message}\n\nPlease check:\n- Is the file_id correct?\n- Is the backend running?\n- Try asking a simpler question.`);
            }
        }

        // Add message to chat
        function addChatMessage(role, content, isTemporary = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();

            const isUser = role === 'user';
            const bgColor = isUser ? '#e3f2fd' : '#f1f8e9';
            const borderColor = isUser ? '#0277bd' : '#2e7d32';
            const icon = isUser ? 'üë§' : 'ü§ñ';
            const name = isUser ? 'You' : 'AI Assistant';

            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                background:${bgColor};
                padding:15px;
                border-radius:8px;
                margin-bottom:15px;
                border-left:4px solid ${borderColor};
                animation: slideIn 0.3s ease;
            `;

            messageDiv.innerHTML = `
                <strong style="color:${borderColor};">${icon} ${name}:</strong>
                <div style="margin:8px 0 0 0; color:#333; white-space:pre-wrap; line-height:1.6;">${content}</div>
            `;

            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return messageId;
        }

        // Clear chat
        function clearChat() {
            if (confirm('Clear all chat messages?')) {
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#999;">
                        <h4 style="color:#667eea; margin-bottom:10px;">üí¨ Chat Cleared</h4>
                        <p>Start asking questions about your PDF!</p>
                    </div>
                `;
            }
        }

        // Insert quick question
        function insertQuickQuestion(question) {
            document.getElementById('chatInput').value = question;
            document.getElementById('chatInput').focus();
        }

        // Add CSS animation for chat messages
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
